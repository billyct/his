/*!jQuery Knob*/
/**
 * Downward compatible, touchable dial
 *
 * Version: 1.2.0 (15/07/2012)
 * Requires: jQuery v1.7+
 *
 * Copyright (c) 2012 Anthony Terrien
 * Under MIT and GPL licenses:
 *  http://www.opensource.org/licenses/mit-license.php
 *  http://www.gnu.org/licenses/gpl.html
 *
 * Thanks to vor, eskimoblood, spiffistan, FabrizioC
 */
(function(a){"use strict";var b={},c=Math.max,d=Math.min;b.c={};b.c.d=a(document);b.c.t=function(a){return a.originalEvent.touches.length-1};b.o=function(){var c=this;this.o=null;this.$=null;this.i=null;this.g=null;this.v=null;this.cv=null;this.x=0;this.y=0;this.$c=null;this.c=null;this.t=0;this.isInit=false;this.fgColor=null;this.pColor=null;this.dH=null;this.cH=null;this.eH=null;this.rH=null;this.run=function(){var b=function(a,b){var d;for(d in b){c.o[d]=b[d]}c.init();c._configure()._draw()};if(this.$.data("kontroled"))return;this.$.data("kontroled",true);this.extend();this.o=a.extend({min:this.$.data("min")||0,max:this.$.data("max")||100,stopper:true,readOnly:this.$.data("readonly"),cursor:this.$.data("cursor")===true&&30||this.$.data("cursor")||0,thickness:this.$.data("thickness")||.35,width:this.$.data("width")||200,height:this.$.data("height")||200,displayInput:this.$.data("displayinput")==null||this.$.data("displayinput"),displayPrevious:this.$.data("displayprevious"),fgColor:this.$.data("fgcolor")||"#87CEEB",inline:false,draw:null,change:null,cancel:null,release:null,"class":null},this.o);if(this.$.is("fieldset")){this.v={};this.i=this.$.find("input");this.i.each(function(b){var d=a(this);c.i[b]=d;c.v[b]=d.val();d.bind("change",function(){var a={};a[b]=d.val();c.val(a)})});this.$.find("legend").remove()}else{this.i=this.$;this.v=this.$.val();this.v==""&&(this.v=this.o.min);this.$.bind("change",function(){c.val(c.$.val())})}!this.o.displayInput&&this.$.hide();this.$c=a('<canvas width="'+this.o.width+'px" height="'+this.o.height+'px"'+(this.o.class?'class="'+this.o.class+'"':"")+"></canvas>");this.c=this.$c[0].getContext("2d");this.$.wrap(a('<div style="'+(this.o.inline?"display:inline;":"")+"width:"+this.o.width+"px;height:"+this.o.height+'px;"></div>')).before(this.$c);if(this.v instanceof Object){this.cv={};this.copy(this.v,this.cv)}else{this.cv=this.v}this.$.bind("configure",b).parent().bind("configure",b);this._listen()._configure()._xy().init();this.isInit=true;this._draw();return this};this._draw=function(){var a=true,b=document.createElement("canvas");b.width=c.o.width;b.height=c.o.height;c.g=b.getContext("2d");c.clear();c.dH&&(a=c.dH());a!==false&&c.draw();c.c.drawImage(b,0,0);b=null};this._touch=function(a){var d=function(a){var b=c.xy2val(a.originalEvent.touches[c.t].pageX,a.originalEvent.touches[c.t].pageY);if(b==c.cv)return;if(c.cH&&c.cH(b)===false)return;c.change(b);c._draw()};this.t=b.c.t(a);d(a);b.c.d.bind("touchmove.k",d).bind("touchend.k",function(){b.c.d.unbind("touchmove.k touchend.k");if(c.rH&&c.rH(c.cv)===false)return;c.val(c.cv)});return this};this._mouse=function(a){var d=function(a){var b=c.xy2val(a.pageX,a.pageY);if(b==c.cv)return;if(c.cH&&c.cH(b)===false)return;c.change(b);c._draw()};d(a);b.c.d.bind("mousemove.k",d).bind("keyup.k",function(a){if(a.keyCode===27){b.c.d.unbind("mouseup.k mousemove.k keyup.k");if(c.eH&&c.eH()===false)return;c.cancel()}}).bind("mouseup.k",function(a){b.c.d.unbind("mousemove.k mouseup.k keyup.k");if(c.rH&&c.rH(c.cv)===false)return;c.val(c.cv)});return this};this._xy=function(){var a=this.$c.offset();this.x=a.left;this.y=a.top;return this};this._listen=function(){if(!this.o.readOnly){this.$c.bind("mousedown",function(a){a.preventDefault();c._xy()._mouse(a)}).bind("touchstart",function(a){a.preventDefault();c._xy()._touch(a)});this.listen()}else{this.$.attr("readonly","readonly")}return this};this._configure=function(){if(this.o.draw)this.dH=this.o.draw;if(this.o.change)this.cH=this.o.change;if(this.o.cancel)this.eH=this.o.cancel;if(this.o.release)this.rH=this.o.release;if(this.o.displayPrevious){this.pColor=this.h2rgba(this.o.fgColor,"0.4");this.fgColor=this.h2rgba(this.o.fgColor,"0.6")}else{this.fgColor=this.o.fgColor}return this};this._clear=function(){this.$c[0].width=this.$c[0].width};this.listen=function(){};this.extend=function(){};this.init=function(){};this.change=function(a){};this.val=function(a){};this.xy2val=function(a,b){};this.draw=function(){};this.clear=function(){this._clear()};this.h2rgba=function(a,b){var c;a=a.substring(1,7);c=[parseInt(a.substring(0,2),16),parseInt(a.substring(2,4),16),parseInt(a.substring(4,6),16)];return"rgba("+c[0]+","+c[1]+","+c[2]+","+b+")"};this.copy=function(a,b){for(var c in a){b[c]=a[c]}}};b.Dial=function(){b.o.call(this);this.startAngle=null;this.xy=null;this.radius=null;this.lineWidth=null;this.cursorExt=null;this.w2=null;this.PI2=2*Math.PI;this.extend=function(){this.o=a.extend({bgColor:this.$.data("bgcolor")||"#EEEEEE",angleOffset:this.$.data("angleoffset")||0,angleArc:this.$.data("anglearc")||360,inline:true},this.o)};this.val=function(a){if(null!=a){this.cv=this.o.stopper?c(d(a,this.o.max),this.o.min):a;this.v=this.cv;this.$.val(this.v);this._draw()}else{return this.v}};this.xy2val=function(a,b){var e,f;e=Math.atan2(a-(this.x+this.w2),-(b-this.y-this.w2))-this.angleOffset;if(this.angleArc!=this.PI2&&e<0&&e>-.5){e=0}else if(e<0){e+=this.PI2}f=~~(.5+e*(this.o.max-this.o.min)/this.angleArc)+this.o.min;this.o.stopper&&(f=c(d(f,this.o.max),this.o.min));return f};this.listen=function(){var b=this,e=function(a){a.preventDefault();var c=a.originalEvent,d=c.detail||c.wheelDeltaX,e=c.detail||c.wheelDeltaY,f=parseInt(b.$.val())+(d>0||e>0?1:d<0||e<0?-1:0);if(b.cH&&b.cH(f)===false)return;b.val(f)},f,g,h=1,i={37:-1,38:1,39:1,40:-1};this.$.bind("keydown",function(e){var j=e.keyCode;if(j>=96&&j<=105){j=e.keyCode=j-48}f=parseInt(String.fromCharCode(j));if(isNaN(f)){j!==13&&j!==8&&j!==9&&j!==189&&e.preventDefault();if(a.inArray(j,[37,38,39,40])>-1){e.preventDefault();var k=parseInt(b.$.val())+i[j]*h;b.o.stopper&&(k=c(d(k,b.o.max),b.o.min));b.change(k);b._draw();g=window.setTimeout(function(){h*=2},30)}}}).bind("keyup",function(a){if(isNaN(f)){if(g){window.clearTimeout(g);g=null;h=1;b.val(b.$.val())}}else{b.$.val()>b.o.max&&b.$.val(b.o.max)||b.$.val()<b.o.min&&b.$.val(b.o.min)}});this.$c.bind("mousewheel DOMMouseScroll",e);this.$.bind("mousewheel DOMMouseScroll",e)};this.init=function(){if(this.v<this.o.min||this.v>this.o.max)this.v=this.o.min;this.$.val(this.v);this.w2=this.o.width/2;this.cursorExt=this.o.cursor/100;this.xy=this.w2;this.lineWidth=this.xy*this.o.thickness;this.radius=this.xy-this.lineWidth/2;this.o.angleOffset&&(this.o.angleOffset=isNaN(this.o.angleOffset)?0:this.o.angleOffset);this.o.angleArc&&(this.o.angleArc=isNaN(this.o.angleArc)?this.PI2:this.o.angleArc);this.angleOffset=this.o.angleOffset*Math.PI/180;this.angleArc=this.o.angleArc*Math.PI/180;this.startAngle=1.5*Math.PI+this.angleOffset;this.endAngle=1.5*Math.PI+this.angleOffset+this.angleArc;var a=c(String(Math.abs(this.o.max)).length,String(Math.abs(this.o.min)).length,2)+2;this.o.displayInput&&this.i.css({width:(this.o.width/2+4>>0)+"px",height:(this.o.width/3>>0)+"px",position:"absolute","vertical-align":"middle","margin-top":(this.o.width/3>>0)+"px","margin-left":"-"+(this.o.width*3/4+2>>0)+"px",border:0,background:"none",font:"bold "+(this.o.width/a>>0)+"px Arial","text-align":"center",color:this.o.fgColor,padding:"0px","-webkit-appearance":"none"})||this.i.css({width:"0px",visibility:"hidden"})};this.change=function(a){this.cv=a;this.$.val(a)};this.angle=function(a){return(a-this.o.min)*this.angleArc/(this.o.max-this.o.min)};this.draw=function(){var a=this.g,b=this.angle(this.cv),c=this.startAngle,d=c+b,e,f,g=1;a.lineWidth=this.lineWidth;this.o.cursor&&(c=d-this.cursorExt)&&(d=d+this.cursorExt);a.beginPath();a.strokeStyle=this.o.bgColor;a.arc(this.xy,this.xy,this.radius,this.endAngle,this.startAngle,true);a.stroke();if(this.o.displayPrevious){f=this.startAngle+this.angle(this.v);e=this.startAngle;this.o.cursor&&(e=f-this.cursorExt)&&(f=f+this.cursorExt);a.beginPath();a.strokeStyle=this.pColor;a.arc(this.xy,this.xy,this.radius,e,f,false);a.stroke();g=this.cv==this.v}a.beginPath();a.strokeStyle=g?this.o.fgColor:this.fgColor;a.arc(this.xy,this.xy,this.radius,c,d,false);a.stroke()};this.cancel=function(){this.val(this.v)}};a.fn.dial=a.fn.knob=function(c){return this.each(function(){var d=new b.Dial;d.o=c;d.$=a(this);d.run()}).parent()}})(jQuery);